package com.tremolosecurity.kubernetes.artifacts;

import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertTrue;

import com.tremolosecurity.kubernetes.artifacts.util.K8sWatcher;

import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.junit.BeforeClass;
import org.junit.Test;

public class TestWatchUtils {
    @BeforeClass
	public static void setUpBeforeClass() throws Exception {
    
    }

    @Test
    public void testObjectHasStatus() throws Exception {
        String json = "{\"apiVersion\":\"openunison.tremolo.io/v1\",\"kind\":\"OpenUnison\",\"metadata\":{\"annotations\":{\"meta.helm.sh/release-name\":\"orchestra\",\"meta.helm.sh/release-namespace\":\"openunison\"},\"creationTimestamp\":\"2020-09-13T17:24:42Z\",\"generation\":2,\"labels\":{\"app.kubernetes.io/managed-by\":\"Helm\"},\"managedFields\":[{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:meta.helm.sh/release-name\":{},\"f:meta.helm.sh/release-namespace\":{}},\"f:labels\":{\".\":{},\"f:app.kubernetes.io/managed-by\":{}}},\"f:spec\":{\".\":{},\"f:dest_secret\":{},\"f:enable_activemq\":{},\"f:hosts\":{},\"f:image\":{},\"f:key_store\":{\".\":{},\"f:key_pairs\":{\".\":{},\"f:create_keypair_template\":{},\"f:keys\":{}},\"f:static_keys\":{},\"f:trusted_certificates\":{},\"f:update_controller\":{\".\":{},\"f:days_to_expire\":{},\"f:image\":{},\"f:schedule\":{}}},\"f:openunison_network_configuration\":{\".\":{},\"f:activemq_dir\":{},\"f:allowed_client_names\":{},\"f:ciphers\":{},\"f:client_auth\":{},\"f:force_to_secure\":{},\"f:open_external_port\":{},\"f:open_port\":{},\"f:path_to_deployment\":{},\"f:path_to_env_file\":{},\"f:quartz_dir\":{},\"f:secure_external_port\":{},\"f:secure_key_alias\":{},\"f:secure_port\":{}},\"f:replicas\":{},\"f:secret_data\":{},\"f:source_secret\":{}}},\"manager\":\"Go-http-client\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:24:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:non_secret_data\":{}}},\"manager\":\"kubectl\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:status\":{\".\":{},\"f:conditions\":{\".\":{},\"f:lastTransitionTime\":{},\"f:status\":{},\"f:type\":{}},\"f:digest\":{}}},\"manager\":\"Apache-HttpClient\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:44Z\"}],\"name\":\"orchestra\",\"namespace\":\"openunison\",\"resourceVersion\":\"4593192\",\"selfLink\":\"/apis/openunison.tremolo.io/v1/namespaces/openunison/openunisons/orchestra\",\"uid\":\"e53f443d-6e92-40d8-9358-eb7d18e53b34\"},\"spec\":{\"dest_secret\":\"orchestra\",\"enable_activemq\":false,\"hosts\":[{\"ingress_name\":\"openunison\",\"names\":[{\"env_var\":\"OU_HOST\",\"name\":\"k8sou.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_DASHBOARD_HOST\",\"name\":\"k8sdb.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_API_HOST\",\"name\":\"k8sapi.apps.192-168-2-144.nip.io\"}],\"secret_name\":\"ou-tls-certificate\"}],\"image\":\"docker.io/tremolosecurity/openunison-k8s-login-activedirectory:latest\",\"key_store\":{\"key_pairs\":{\"create_keypair_template\":[{\"name\":\"ou\",\"value\":\"Kubernetes\"},{\"name\":\"o\",\"value\":\"MyOrg\"},{\"name\":\"l\",\"value\":\"My Cluster\"},{\"name\":\"st\",\"value\":\"State of Cluster\"},{\"name\":\"c\",\"value\":\"MyCountry\"}],\"keys\":[{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"openunison.openunison.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-tls\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"k8sou.apps.192-168-2-144.nip.io\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[\"k8sdb.apps.192-168-2-144.nip.io\",\"k8sapi.apps.192-168-2-144.nip.io\"]},\"import_into_ks\":\"certificate\",\"name\":\"unison-ca\",\"tls_secret_name\":\"ou-tls-certificate\"},{\"create_data\":{\"ca_cert\":true,\"delete_pods_labels\":[\"k8s-app=kubernetes-dashboard\"],\"key_size\":2048,\"secret_info\":{\"cert_name\":\"dashboard.crt\",\"key_name\":\"dashboard.key\",\"type_of_secret\":\"Opaque\"},\"server_name\":\"kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[],\"target_namespace\":\"kubernetes-dashboard\"},\"import_into_ks\":\"certificate\",\"name\":\"kubernetes-dashboard\",\"replace_if_exists\":true,\"tls_secret_name\":\"kubernetes-dashboard-certs\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"unison-saml2-rp-sig\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-saml2-rp-sig\"}]},\"static_keys\":[{\"name\":\"session-unison\",\"version\":1},{\"name\":\"lastmile-oidc\",\"version\":1}],\"trusted_certificates\":[{\"name\":\"ldaps\",\"pem_data\":\"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURORENDQWh5Z0F3SUJBZ0lRYlJOajZSS3F0cVZQdlc2NXFaeFhYakFOQmdrcWhraUc5dzBCQVFVRkFEQWkKTVNBd0hnWURWUVFEREJkQlJFWlRMa1ZPVkRKTE1USXVSRTlOUVVsT0xrTlBUVEFlRncweE5EQXpNamd3TVRBMQpNek5hRncweU5EQXpNalV3TVRBMU16TmFNQ0l4SURBZUJnTlZCQU1NRjBGRVJsTXVSVTVVTWtzeE1pNUVUMDFCClNVNHVRMDlOTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyczlKa2VOQUhPa1EKMVFZSmdqZWZVd2Nhb2dFTWNhVy9rb0ErYnU5eGJyNHJIeS8yZ04va2M4T2tvUHV3Si9uTmxPSU8rcytNYm5YUwpMOW1VVEM0T0s3dHJrRWppS1hCK0QrVlNZeTZpbVhoNnpwQnROYmVaeXgrcmRCbmFPdjNCeVpSbm5FQjhMbWhNCnZIQSs0Zi90OWZ4LzJ2dDZ3UHgvL1ZnSXE5eXVZWVVRUkxtMVdqeVVCRnJaZUdvU3BQbTBLZXdtK0IwYmhtTWIKZHlDKzNmaGFLQytVazFOUG9kRTI5NzNqTEJaSmVsWnhzWlk0MFd3OHpZUXdkR1lJYlhxb1RjKzFhL3g0ZjFFbgptNEFOcWdnSHR3K05xOHpoc3MzeVR0WStVWUtEUkJJTGRMVlpRaEhKRXhlMGtBZWlzZ014SS9iQndPMUhickZWCit6U25rK252Z1FJREFRQUJvMll3WkRBekJnTlZIU1VFTERBcUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SUcKQ2lzR0FRUUJnamNVQWdJR0NDc0dBUVVGQndNRE1CMEdBMVVkRGdRV0JCVHlKVWZZNjZ6WWJtOWkweGVZSHVGSQo0TU43dURBT0JnTlZIUThCQWY4RUJBTUNCU0F3RFFZSktvWklodmNOQVFFRkJRQURnZ0VCQU01a3o5T0tOU3VYCjh3NE5PZ25mSUZkYXpkMG5QbElVYnZEVmZRb055OVEwUzFTRlVWTWVrSVBOaVZoZkd6eWE5SXdSdEdiMVZhQlEKQVEyT1JJekhyOEEycjVVTkx4M21GanBKbWVPeFF3bFYwWCtnOHMrMjUzS1ZGeE9wUkU2eXlhZ24vQnh4cHRUTAphMVo0cWVRSkxENDJsZDFxR2xSd0Z0VlJtVkZaelZYVnJwdTdOdUZkM3Zsbm5PL3FLV1hVK3VNc2ZYdHNsMTNuCmVjMWt3MUV3cTJqbks4V0ltS1RRNy85V2JhSVkwZ3g4bW93Q0pTT3NScTBURTd6Sy9ONTVkck4xd1hKVnhXZTUKNE4zMmVDcW90WHk5ajlsemRrTmE3YXdiOXEzOG5XVnhQK3ZhNWpxTklEbGxqQjZ0RXh5NW4zczd0NktLNmc1agpUWmdWcXJaMyttcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQoK\"}],\"update_controller\":{\"days_to_expire\":10,\"image\":\"docker.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0\",\"schedule\":\"0 2 * * *\"}},\"non_secret_data\":[{\"name\":\"K8S_URL\",\"value\":\"https://k8sapi.apps.192-168-2-144.nip.io\"},{\"name\":\"AD_BASE_DN\",\"value\":\"cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_HOST\",\"value\":\"192.168.2.75\"},{\"name\":\"AD_PORT\",\"value\":\"636\"},{\"name\":\"AD_BIND_DN\",\"value\":\"cn=Administrator,cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_CON_TYPE\",\"value\":\"ldaps\"},{\"name\":\"SRV_DNS\",\"value\":\"false\"},{\"name\":\"SESSION_INACTIVITY_TIMEOUT_SECONDS\",\"value\":\"900\"},{\"name\":\"MYVD_CONFIG_PATH\",\"value\":\"WEB-INF/myvd.conf\"},{\"name\":\"K8S_DASHBOARD_NAMESPACE\",\"value\":\"kubernetes-dashboard\"},{\"name\":\"K8S_CLUSTER_NAME\",\"value\":\"kubernetes\"},{\"name\":\"K8S_IMPERSONATION\",\"value\":\"true\"},{\"name\":\"PROMETHEUS_SERVICE_ACCOUNT\",\"value\":\"system:serviceaccount:monitoring:prometheus-k8s\"},{\"name\":\"SHOW_PORTAL_ORGS\",\"value\":\"true\"}],\"openunison_network_configuration\":{\"activemq_dir\":\"/tmp/amq\",\"allowed_client_names\":[],\"ciphers\":[\"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\"],\"client_auth\":\"none\",\"force_to_secure\":true,\"open_external_port\":80,\"open_port\":8080,\"path_to_deployment\":\"/usr/local/openunison/work\",\"path_to_env_file\":\"/etc/openunison/ou.env\",\"quartz_dir\":\"/tmp/quartz\",\"secure_external_port\":443,\"secure_key_alias\":\"unison-tls\",\"secure_port\":8443},\"replicas\":1,\"secret_data\":[\"AD_BIND_PASSWORD\",\"K8S_DB_SECRET\",\"unisonKeystorePassword\"],\"source_secret\":\"orchestra-secrets-source\"},\"status\":{\"conditions\":{\"lastTransitionTime\":\"2020-09-13 05:50:44GMT\",\"status\":\"True\",\"type\":\"Completed\"},\"digest\":\"+pXYDf/HO3q05phi6btzAKmFO1hun06uNtBx7OHJ6i8=\"}}";
        JSONObject obj = (JSONObject) new JSONParser().parse(json);
        assertTrue(K8sWatcher.hasStatus(obj));
    }

    @Test
    public void testObjectHasNoStatus() throws Exception {
        String json = "{\"apiVersion\":\"openunison.tremolo.io/v1\",\"kind\":\"OpenUnison\",\"metadata\":{\"annotations\":{\"meta.helm.sh/release-name\":\"orchestra\",\"meta.helm.sh/release-namespace\":\"openunison\"},\"creationTimestamp\":\"2020-09-13T17:24:42Z\",\"generation\":2,\"labels\":{\"app.kubernetes.io/managed-by\":\"Helm\"},\"managedFields\":[{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:meta.helm.sh/release-name\":{},\"f:meta.helm.sh/release-namespace\":{}},\"f:labels\":{\".\":{},\"f:app.kubernetes.io/managed-by\":{}}},\"f:spec\":{\".\":{},\"f:dest_secret\":{},\"f:enable_activemq\":{},\"f:hosts\":{},\"f:image\":{},\"f:key_store\":{\".\":{},\"f:key_pairs\":{\".\":{},\"f:create_keypair_template\":{},\"f:keys\":{}},\"f:static_keys\":{},\"f:trusted_certificates\":{},\"f:update_controller\":{\".\":{},\"f:days_to_expire\":{},\"f:image\":{},\"f:schedule\":{}}},\"f:openunison_network_configuration\":{\".\":{},\"f:activemq_dir\":{},\"f:allowed_client_names\":{},\"f:ciphers\":{},\"f:client_auth\":{},\"f:force_to_secure\":{},\"f:open_external_port\":{},\"f:open_port\":{},\"f:path_to_deployment\":{},\"f:path_to_env_file\":{},\"f:quartz_dir\":{},\"f:secure_external_port\":{},\"f:secure_key_alias\":{},\"f:secure_port\":{}},\"f:replicas\":{},\"f:secret_data\":{},\"f:source_secret\":{}}},\"manager\":\"Go-http-client\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:24:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:non_secret_data\":{}}},\"manager\":\"kubectl\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:status\":{\".\":{},\"f:conditions\":{\".\":{},\"f:lastTransitionTime\":{},\"f:status\":{},\"f:type\":{}},\"f:digest\":{}}},\"manager\":\"Apache-HttpClient\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:44Z\"}],\"name\":\"orchestra\",\"namespace\":\"openunison\",\"resourceVersion\":\"4593192\",\"selfLink\":\"/apis/openunison.tremolo.io/v1/namespaces/openunison/openunisons/orchestra\",\"uid\":\"e53f443d-6e92-40d8-9358-eb7d18e53b34\"},\"spec\":{\"dest_secret\":\"orchestra\",\"enable_activemq\":false,\"hosts\":[{\"ingress_name\":\"openunison\",\"names\":[{\"env_var\":\"OU_HOST\",\"name\":\"k8sou.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_DASHBOARD_HOST\",\"name\":\"k8sdb.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_API_HOST\",\"name\":\"k8sapi.apps.192-168-2-144.nip.io\"}],\"secret_name\":\"ou-tls-certificate\"}],\"image\":\"docker.io/tremolosecurity/openunison-k8s-login-activedirectory:latest\",\"key_store\":{\"key_pairs\":{\"create_keypair_template\":[{\"name\":\"ou\",\"value\":\"Kubernetes\"},{\"name\":\"o\",\"value\":\"MyOrg\"},{\"name\":\"l\",\"value\":\"My Cluster\"},{\"name\":\"st\",\"value\":\"State of Cluster\"},{\"name\":\"c\",\"value\":\"MyCountry\"}],\"keys\":[{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"openunison.openunison.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-tls\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"k8sou.apps.192-168-2-144.nip.io\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[\"k8sdb.apps.192-168-2-144.nip.io\",\"k8sapi.apps.192-168-2-144.nip.io\"]},\"import_into_ks\":\"certificate\",\"name\":\"unison-ca\",\"tls_secret_name\":\"ou-tls-certificate\"},{\"create_data\":{\"ca_cert\":true,\"delete_pods_labels\":[\"k8s-app=kubernetes-dashboard\"],\"key_size\":2048,\"secret_info\":{\"cert_name\":\"dashboard.crt\",\"key_name\":\"dashboard.key\",\"type_of_secret\":\"Opaque\"},\"server_name\":\"kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[],\"target_namespace\":\"kubernetes-dashboard\"},\"import_into_ks\":\"certificate\",\"name\":\"kubernetes-dashboard\",\"replace_if_exists\":true,\"tls_secret_name\":\"kubernetes-dashboard-certs\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"unison-saml2-rp-sig\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-saml2-rp-sig\"}]},\"static_keys\":[{\"name\":\"session-unison\",\"version\":1},{\"name\":\"lastmile-oidc\",\"version\":1}],\"trusted_certificates\":[{\"name\":\"ldaps\",\"pem_data\":\"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURORENDQWh5Z0F3SUJBZ0lRYlJOajZSS3F0cVZQdlc2NXFaeFhYakFOQmdrcWhraUc5dzBCQVFVRkFEQWkKTVNBd0hnWURWUVFEREJkQlJFWlRMa1ZPVkRKTE1USXVSRTlOUVVsT0xrTlBUVEFlRncweE5EQXpNamd3TVRBMQpNek5hRncweU5EQXpNalV3TVRBMU16TmFNQ0l4SURBZUJnTlZCQU1NRjBGRVJsTXVSVTVVTWtzeE1pNUVUMDFCClNVNHVRMDlOTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyczlKa2VOQUhPa1EKMVFZSmdqZWZVd2Nhb2dFTWNhVy9rb0ErYnU5eGJyNHJIeS8yZ04va2M4T2tvUHV3Si9uTmxPSU8rcytNYm5YUwpMOW1VVEM0T0s3dHJrRWppS1hCK0QrVlNZeTZpbVhoNnpwQnROYmVaeXgrcmRCbmFPdjNCeVpSbm5FQjhMbWhNCnZIQSs0Zi90OWZ4LzJ2dDZ3UHgvL1ZnSXE5eXVZWVVRUkxtMVdqeVVCRnJaZUdvU3BQbTBLZXdtK0IwYmhtTWIKZHlDKzNmaGFLQytVazFOUG9kRTI5NzNqTEJaSmVsWnhzWlk0MFd3OHpZUXdkR1lJYlhxb1RjKzFhL3g0ZjFFbgptNEFOcWdnSHR3K05xOHpoc3MzeVR0WStVWUtEUkJJTGRMVlpRaEhKRXhlMGtBZWlzZ014SS9iQndPMUhickZWCit6U25rK252Z1FJREFRQUJvMll3WkRBekJnTlZIU1VFTERBcUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SUcKQ2lzR0FRUUJnamNVQWdJR0NDc0dBUVVGQndNRE1CMEdBMVVkRGdRV0JCVHlKVWZZNjZ6WWJtOWkweGVZSHVGSQo0TU43dURBT0JnTlZIUThCQWY4RUJBTUNCU0F3RFFZSktvWklodmNOQVFFRkJRQURnZ0VCQU01a3o5T0tOU3VYCjh3NE5PZ25mSUZkYXpkMG5QbElVYnZEVmZRb055OVEwUzFTRlVWTWVrSVBOaVZoZkd6eWE5SXdSdEdiMVZhQlEKQVEyT1JJekhyOEEycjVVTkx4M21GanBKbWVPeFF3bFYwWCtnOHMrMjUzS1ZGeE9wUkU2eXlhZ24vQnh4cHRUTAphMVo0cWVRSkxENDJsZDFxR2xSd0Z0VlJtVkZaelZYVnJwdTdOdUZkM3Zsbm5PL3FLV1hVK3VNc2ZYdHNsMTNuCmVjMWt3MUV3cTJqbks4V0ltS1RRNy85V2JhSVkwZ3g4bW93Q0pTT3NScTBURTd6Sy9ONTVkck4xd1hKVnhXZTUKNE4zMmVDcW90WHk5ajlsemRrTmE3YXdiOXEzOG5XVnhQK3ZhNWpxTklEbGxqQjZ0RXh5NW4zczd0NktLNmc1agpUWmdWcXJaMyttcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQoK\"}],\"update_controller\":{\"days_to_expire\":10,\"image\":\"docker.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0\",\"schedule\":\"0 2 * * *\"}},\"non_secret_data\":[{\"name\":\"K8S_URL\",\"value\":\"https://k8sapi.apps.192-168-2-144.nip.io\"},{\"name\":\"AD_BASE_DN\",\"value\":\"cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_HOST\",\"value\":\"192.168.2.75\"},{\"name\":\"AD_PORT\",\"value\":\"636\"},{\"name\":\"AD_BIND_DN\",\"value\":\"cn=Administrator,cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_CON_TYPE\",\"value\":\"ldaps\"},{\"name\":\"SRV_DNS\",\"value\":\"false\"},{\"name\":\"SESSION_INACTIVITY_TIMEOUT_SECONDS\",\"value\":\"900\"},{\"name\":\"MYVD_CONFIG_PATH\",\"value\":\"WEB-INF/myvd.conf\"},{\"name\":\"K8S_DASHBOARD_NAMESPACE\",\"value\":\"kubernetes-dashboard\"},{\"name\":\"K8S_CLUSTER_NAME\",\"value\":\"kubernetes\"},{\"name\":\"K8S_IMPERSONATION\",\"value\":\"true\"},{\"name\":\"PROMETHEUS_SERVICE_ACCOUNT\",\"value\":\"system:serviceaccount:monitoring:prometheus-k8s\"},{\"name\":\"SHOW_PORTAL_ORGS\",\"value\":\"true\"}],\"openunison_network_configuration\":{\"activemq_dir\":\"/tmp/amq\",\"allowed_client_names\":[],\"ciphers\":[\"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\"],\"client_auth\":\"none\",\"force_to_secure\":true,\"open_external_port\":80,\"open_port\":8080,\"path_to_deployment\":\"/usr/local/openunison/work\",\"path_to_env_file\":\"/etc/openunison/ou.env\",\"quartz_dir\":\"/tmp/quartz\",\"secure_external_port\":443,\"secure_key_alias\":\"unison-tls\",\"secure_port\":8443},\"replicas\":1,\"secret_data\":[\"AD_BIND_PASSWORD\",\"K8S_DB_SECRET\",\"unisonKeystorePassword\"],\"source_secret\":\"orchestra-secrets-source\"}}";
        JSONObject obj = (JSONObject) new JSONParser().parse(json);
        assertFalse(K8sWatcher.hasStatus(obj));
    }

    @Test
    public void testObjectNotChanged() throws Exception {
        String json = "{\"apiVersion\":\"openunison.tremolo.io/v1\",\"kind\":\"OpenUnison\",\"metadata\":{\"annotations\":{\"meta.helm.sh/release-name\":\"orchestra\",\"meta.helm.sh/release-namespace\":\"openunison\"},\"creationTimestamp\":\"2020-09-13T17:24:42Z\",\"generation\":2,\"labels\":{\"app.kubernetes.io/managed-by\":\"Helm\"},\"managedFields\":[{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:meta.helm.sh/release-name\":{},\"f:meta.helm.sh/release-namespace\":{}},\"f:labels\":{\".\":{},\"f:app.kubernetes.io/managed-by\":{}}},\"f:spec\":{\".\":{},\"f:dest_secret\":{},\"f:enable_activemq\":{},\"f:hosts\":{},\"f:image\":{},\"f:key_store\":{\".\":{},\"f:key_pairs\":{\".\":{},\"f:create_keypair_template\":{},\"f:keys\":{}},\"f:static_keys\":{},\"f:trusted_certificates\":{},\"f:update_controller\":{\".\":{},\"f:days_to_expire\":{},\"f:image\":{},\"f:schedule\":{}}},\"f:openunison_network_configuration\":{\".\":{},\"f:activemq_dir\":{},\"f:allowed_client_names\":{},\"f:ciphers\":{},\"f:client_auth\":{},\"f:force_to_secure\":{},\"f:open_external_port\":{},\"f:open_port\":{},\"f:path_to_deployment\":{},\"f:path_to_env_file\":{},\"f:quartz_dir\":{},\"f:secure_external_port\":{},\"f:secure_key_alias\":{},\"f:secure_port\":{}},\"f:replicas\":{},\"f:secret_data\":{},\"f:source_secret\":{}}},\"manager\":\"Go-http-client\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:24:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:non_secret_data\":{}}},\"manager\":\"kubectl\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:status\":{\".\":{},\"f:conditions\":{\".\":{},\"f:lastTransitionTime\":{},\"f:status\":{},\"f:type\":{}},\"f:digest\":{}}},\"manager\":\"Apache-HttpClient\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:44Z\"}],\"name\":\"orchestra\",\"namespace\":\"openunison\",\"resourceVersion\":\"4593192\",\"selfLink\":\"/apis/openunison.tremolo.io/v1/namespaces/openunison/openunisons/orchestra\",\"uid\":\"e53f443d-6e92-40d8-9358-eb7d18e53b34\"},\"spec\":{\"dest_secret\":\"orchestra\",\"enable_activemq\":false,\"hosts\":[{\"ingress_name\":\"openunison\",\"names\":[{\"env_var\":\"OU_HOST\",\"name\":\"k8sou.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_DASHBOARD_HOST\",\"name\":\"k8sdb.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_API_HOST\",\"name\":\"k8sapi.apps.192-168-2-144.nip.io\"}],\"secret_name\":\"ou-tls-certificate\"}],\"image\":\"docker.io/tremolosecurity/openunison-k8s-login-activedirectory:latest\",\"key_store\":{\"key_pairs\":{\"create_keypair_template\":[{\"name\":\"ou\",\"value\":\"Kubernetes\"},{\"name\":\"o\",\"value\":\"MyOrg\"},{\"name\":\"l\",\"value\":\"My Cluster\"},{\"name\":\"st\",\"value\":\"State of Cluster\"},{\"name\":\"c\",\"value\":\"MyCountry\"}],\"keys\":[{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"openunison.openunison.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-tls\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"k8sou.apps.192-168-2-144.nip.io\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[\"k8sdb.apps.192-168-2-144.nip.io\",\"k8sapi.apps.192-168-2-144.nip.io\"]},\"import_into_ks\":\"certificate\",\"name\":\"unison-ca\",\"tls_secret_name\":\"ou-tls-certificate\"},{\"create_data\":{\"ca_cert\":true,\"delete_pods_labels\":[\"k8s-app=kubernetes-dashboard\"],\"key_size\":2048,\"secret_info\":{\"cert_name\":\"dashboard.crt\",\"key_name\":\"dashboard.key\",\"type_of_secret\":\"Opaque\"},\"server_name\":\"kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[],\"target_namespace\":\"kubernetes-dashboard\"},\"import_into_ks\":\"certificate\",\"name\":\"kubernetes-dashboard\",\"replace_if_exists\":true,\"tls_secret_name\":\"kubernetes-dashboard-certs\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"unison-saml2-rp-sig\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-saml2-rp-sig\"}]},\"static_keys\":[{\"name\":\"session-unison\",\"version\":1},{\"name\":\"lastmile-oidc\",\"version\":1}],\"trusted_certificates\":[{\"name\":\"ldaps\",\"pem_data\":\"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURORENDQWh5Z0F3SUJBZ0lRYlJOajZSS3F0cVZQdlc2NXFaeFhYakFOQmdrcWhraUc5dzBCQVFVRkFEQWkKTVNBd0hnWURWUVFEREJkQlJFWlRMa1ZPVkRKTE1USXVSRTlOUVVsT0xrTlBUVEFlRncweE5EQXpNamd3TVRBMQpNek5hRncweU5EQXpNalV3TVRBMU16TmFNQ0l4SURBZUJnTlZCQU1NRjBGRVJsTXVSVTVVTWtzeE1pNUVUMDFCClNVNHVRMDlOTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyczlKa2VOQUhPa1EKMVFZSmdqZWZVd2Nhb2dFTWNhVy9rb0ErYnU5eGJyNHJIeS8yZ04va2M4T2tvUHV3Si9uTmxPSU8rcytNYm5YUwpMOW1VVEM0T0s3dHJrRWppS1hCK0QrVlNZeTZpbVhoNnpwQnROYmVaeXgrcmRCbmFPdjNCeVpSbm5FQjhMbWhNCnZIQSs0Zi90OWZ4LzJ2dDZ3UHgvL1ZnSXE5eXVZWVVRUkxtMVdqeVVCRnJaZUdvU3BQbTBLZXdtK0IwYmhtTWIKZHlDKzNmaGFLQytVazFOUG9kRTI5NzNqTEJaSmVsWnhzWlk0MFd3OHpZUXdkR1lJYlhxb1RjKzFhL3g0ZjFFbgptNEFOcWdnSHR3K05xOHpoc3MzeVR0WStVWUtEUkJJTGRMVlpRaEhKRXhlMGtBZWlzZ014SS9iQndPMUhickZWCit6U25rK252Z1FJREFRQUJvMll3WkRBekJnTlZIU1VFTERBcUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SUcKQ2lzR0FRUUJnamNVQWdJR0NDc0dBUVVGQndNRE1CMEdBMVVkRGdRV0JCVHlKVWZZNjZ6WWJtOWkweGVZSHVGSQo0TU43dURBT0JnTlZIUThCQWY4RUJBTUNCU0F3RFFZSktvWklodmNOQVFFRkJRQURnZ0VCQU01a3o5T0tOU3VYCjh3NE5PZ25mSUZkYXpkMG5QbElVYnZEVmZRb055OVEwUzFTRlVWTWVrSVBOaVZoZkd6eWE5SXdSdEdiMVZhQlEKQVEyT1JJekhyOEEycjVVTkx4M21GanBKbWVPeFF3bFYwWCtnOHMrMjUzS1ZGeE9wUkU2eXlhZ24vQnh4cHRUTAphMVo0cWVRSkxENDJsZDFxR2xSd0Z0VlJtVkZaelZYVnJwdTdOdUZkM3Zsbm5PL3FLV1hVK3VNc2ZYdHNsMTNuCmVjMWt3MUV3cTJqbks4V0ltS1RRNy85V2JhSVkwZ3g4bW93Q0pTT3NScTBURTd6Sy9ONTVkck4xd1hKVnhXZTUKNE4zMmVDcW90WHk5ajlsemRrTmE3YXdiOXEzOG5XVnhQK3ZhNWpxTklEbGxqQjZ0RXh5NW4zczd0NktLNmc1agpUWmdWcXJaMyttcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQoK\"}],\"update_controller\":{\"days_to_expire\":10,\"image\":\"docker.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0\",\"schedule\":\"0 2 * * *\"}},\"non_secret_data\":[{\"name\":\"K8S_URL\",\"value\":\"https://k8sapi.apps.192-168-2-144.nip.io\"},{\"name\":\"AD_BASE_DN\",\"value\":\"cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_HOST\",\"value\":\"192.168.2.75\"},{\"name\":\"AD_PORT\",\"value\":\"636\"},{\"name\":\"AD_BIND_DN\",\"value\":\"cn=Administrator,cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_CON_TYPE\",\"value\":\"ldaps\"},{\"name\":\"SRV_DNS\",\"value\":\"false\"},{\"name\":\"SESSION_INACTIVITY_TIMEOUT_SECONDS\",\"value\":\"900\"},{\"name\":\"MYVD_CONFIG_PATH\",\"value\":\"WEB-INF/myvd.conf\"},{\"name\":\"K8S_DASHBOARD_NAMESPACE\",\"value\":\"kubernetes-dashboard\"},{\"name\":\"K8S_CLUSTER_NAME\",\"value\":\"kubernetes\"},{\"name\":\"K8S_IMPERSONATION\",\"value\":\"true\"},{\"name\":\"PROMETHEUS_SERVICE_ACCOUNT\",\"value\":\"system:serviceaccount:monitoring:prometheus-k8s\"},{\"name\":\"SHOW_PORTAL_ORGS\",\"value\":\"true\"}],\"openunison_network_configuration\":{\"activemq_dir\":\"/tmp/amq\",\"allowed_client_names\":[],\"ciphers\":[\"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\"],\"client_auth\":\"none\",\"force_to_secure\":true,\"open_external_port\":80,\"open_port\":8080,\"path_to_deployment\":\"/usr/local/openunison/work\",\"path_to_env_file\":\"/etc/openunison/ou.env\",\"quartz_dir\":\"/tmp/quartz\",\"secure_external_port\":443,\"secure_key_alias\":\"unison-tls\",\"secure_port\":8443},\"replicas\":1,\"secret_data\":[\"AD_BIND_PASSWORD\",\"K8S_DB_SECRET\",\"unisonKeystorePassword\"],\"source_secret\":\"orchestra-secrets-source\"},\"status\":{\"conditions\":{\"lastTransitionTime\":\"2020-09-13 05:50:44GMT\",\"status\":\"True\",\"type\":\"Completed\"},\"digest\":\"+pXYDf/HO3q05phi6btzAKmFO1hun06uNtBx7OHJ6i8=\"}}";
        JSONObject obj = (JSONObject) new JSONParser().parse(json);
        assertFalse(K8sWatcher.hasObjectChanged(obj));
    }

    @Test
    public void testObjectNoStatusHasChanged() throws Exception {
        String json = "{\"apiVersion\":\"openunison.tremolo.io/v1\",\"kind\":\"OpenUnison\",\"metadata\":{\"annotations\":{\"meta.helm.sh/release-name\":\"orchestra\",\"meta.helm.sh/release-namespace\":\"openunison\"},\"creationTimestamp\":\"2020-09-13T17:24:42Z\",\"generation\":2,\"labels\":{\"app.kubernetes.io/managed-by\":\"Helm\"},\"managedFields\":[{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:meta.helm.sh/release-name\":{},\"f:meta.helm.sh/release-namespace\":{}},\"f:labels\":{\".\":{},\"f:app.kubernetes.io/managed-by\":{}}},\"f:spec\":{\".\":{},\"f:dest_secret\":{},\"f:enable_activemq\":{},\"f:hosts\":{},\"f:image\":{},\"f:key_store\":{\".\":{},\"f:key_pairs\":{\".\":{},\"f:create_keypair_template\":{},\"f:keys\":{}},\"f:static_keys\":{},\"f:trusted_certificates\":{},\"f:update_controller\":{\".\":{},\"f:days_to_expire\":{},\"f:image\":{},\"f:schedule\":{}}},\"f:openunison_network_configuration\":{\".\":{},\"f:activemq_dir\":{},\"f:allowed_client_names\":{},\"f:ciphers\":{},\"f:client_auth\":{},\"f:force_to_secure\":{},\"f:open_external_port\":{},\"f:open_port\":{},\"f:path_to_deployment\":{},\"f:path_to_env_file\":{},\"f:quartz_dir\":{},\"f:secure_external_port\":{},\"f:secure_key_alias\":{},\"f:secure_port\":{}},\"f:replicas\":{},\"f:secret_data\":{},\"f:source_secret\":{}}},\"manager\":\"Go-http-client\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:24:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:non_secret_data\":{}}},\"manager\":\"kubectl\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:status\":{\".\":{},\"f:conditions\":{\".\":{},\"f:lastTransitionTime\":{},\"f:status\":{},\"f:type\":{}},\"f:digest\":{}}},\"manager\":\"Apache-HttpClient\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:44Z\"}],\"name\":\"orchestra\",\"namespace\":\"openunison\",\"resourceVersion\":\"4593192\",\"selfLink\":\"/apis/openunison.tremolo.io/v1/namespaces/openunison/openunisons/orchestra\",\"uid\":\"e53f443d-6e92-40d8-9358-eb7d18e53b34\"},\"spec\":{\"dest_secret\":\"orchestra\",\"enable_activemq\":false,\"hosts\":[{\"ingress_name\":\"openunison\",\"names\":[{\"env_var\":\"OU_HOST\",\"name\":\"k8sou.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_DASHBOARD_HOST\",\"name\":\"k8sdb.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_API_HOST\",\"name\":\"k8sapi.apps.192-168-2-144.nip.io\"}],\"secret_name\":\"ou-tls-certificate\"}],\"image\":\"docker.io/tremolosecurity/openunison-k8s-login-activedirectory:latest\",\"key_store\":{\"key_pairs\":{\"create_keypair_template\":[{\"name\":\"ou\",\"value\":\"Kubernetes\"},{\"name\":\"o\",\"value\":\"MyOrg\"},{\"name\":\"l\",\"value\":\"My Cluster\"},{\"name\":\"st\",\"value\":\"State of Cluster\"},{\"name\":\"c\",\"value\":\"MyCountry\"}],\"keys\":[{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"openunison.openunison.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-tls\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"k8sou.apps.192-168-2-144.nip.io\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[\"k8sdb.apps.192-168-2-144.nip.io\",\"k8sapi.apps.192-168-2-144.nip.io\"]},\"import_into_ks\":\"certificate\",\"name\":\"unison-ca\",\"tls_secret_name\":\"ou-tls-certificate\"},{\"create_data\":{\"ca_cert\":true,\"delete_pods_labels\":[\"k8s-app=kubernetes-dashboard\"],\"key_size\":2048,\"secret_info\":{\"cert_name\":\"dashboard.crt\",\"key_name\":\"dashboard.key\",\"type_of_secret\":\"Opaque\"},\"server_name\":\"kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[],\"target_namespace\":\"kubernetes-dashboard\"},\"import_into_ks\":\"certificate\",\"name\":\"kubernetes-dashboard\",\"replace_if_exists\":true,\"tls_secret_name\":\"kubernetes-dashboard-certs\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"unison-saml2-rp-sig\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-saml2-rp-sig\"}]},\"static_keys\":[{\"name\":\"session-unison\",\"version\":1},{\"name\":\"lastmile-oidc\",\"version\":1}],\"trusted_certificates\":[{\"name\":\"ldaps\",\"pem_data\":\"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURORENDQWh5Z0F3SUJBZ0lRYlJOajZSS3F0cVZQdlc2NXFaeFhYakFOQmdrcWhraUc5dzBCQVFVRkFEQWkKTVNBd0hnWURWUVFEREJkQlJFWlRMa1ZPVkRKTE1USXVSRTlOUVVsT0xrTlBUVEFlRncweE5EQXpNamd3TVRBMQpNek5hRncweU5EQXpNalV3TVRBMU16TmFNQ0l4SURBZUJnTlZCQU1NRjBGRVJsTXVSVTVVTWtzeE1pNUVUMDFCClNVNHVRMDlOTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyczlKa2VOQUhPa1EKMVFZSmdqZWZVd2Nhb2dFTWNhVy9rb0ErYnU5eGJyNHJIeS8yZ04va2M4T2tvUHV3Si9uTmxPSU8rcytNYm5YUwpMOW1VVEM0T0s3dHJrRWppS1hCK0QrVlNZeTZpbVhoNnpwQnROYmVaeXgrcmRCbmFPdjNCeVpSbm5FQjhMbWhNCnZIQSs0Zi90OWZ4LzJ2dDZ3UHgvL1ZnSXE5eXVZWVVRUkxtMVdqeVVCRnJaZUdvU3BQbTBLZXdtK0IwYmhtTWIKZHlDKzNmaGFLQytVazFOUG9kRTI5NzNqTEJaSmVsWnhzWlk0MFd3OHpZUXdkR1lJYlhxb1RjKzFhL3g0ZjFFbgptNEFOcWdnSHR3K05xOHpoc3MzeVR0WStVWUtEUkJJTGRMVlpRaEhKRXhlMGtBZWlzZ014SS9iQndPMUhickZWCit6U25rK252Z1FJREFRQUJvMll3WkRBekJnTlZIU1VFTERBcUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SUcKQ2lzR0FRUUJnamNVQWdJR0NDc0dBUVVGQndNRE1CMEdBMVVkRGdRV0JCVHlKVWZZNjZ6WWJtOWkweGVZSHVGSQo0TU43dURBT0JnTlZIUThCQWY4RUJBTUNCU0F3RFFZSktvWklodmNOQVFFRkJRQURnZ0VCQU01a3o5T0tOU3VYCjh3NE5PZ25mSUZkYXpkMG5QbElVYnZEVmZRb055OVEwUzFTRlVWTWVrSVBOaVZoZkd6eWE5SXdSdEdiMVZhQlEKQVEyT1JJekhyOEEycjVVTkx4M21GanBKbWVPeFF3bFYwWCtnOHMrMjUzS1ZGeE9wUkU2eXlhZ24vQnh4cHRUTAphMVo0cWVRSkxENDJsZDFxR2xSd0Z0VlJtVkZaelZYVnJwdTdOdUZkM3Zsbm5PL3FLV1hVK3VNc2ZYdHNsMTNuCmVjMWt3MUV3cTJqbks4V0ltS1RRNy85V2JhSVkwZ3g4bW93Q0pTT3NScTBURTd6Sy9ONTVkck4xd1hKVnhXZTUKNE4zMmVDcW90WHk5ajlsemRrTmE3YXdiOXEzOG5XVnhQK3ZhNWpxTklEbGxqQjZ0RXh5NW4zczd0NktLNmc1agpUWmdWcXJaMyttcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQoK\"}],\"update_controller\":{\"days_to_expire\":10,\"image\":\"docker.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0\",\"schedule\":\"0 2 * * *\"}},\"non_secret_data\":[{\"name\":\"K8S_URL\",\"value\":\"https://k8sapi.apps.192-168-2-144.nip.io\"},{\"name\":\"AD_BASE_DN\",\"value\":\"cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_HOST\",\"value\":\"192.168.2.75\"},{\"name\":\"AD_PORT\",\"value\":\"636\"},{\"name\":\"AD_BIND_DN\",\"value\":\"cn=Administrator,cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_CON_TYPE\",\"value\":\"ldaps\"},{\"name\":\"SRV_DNS\",\"value\":\"false\"},{\"name\":\"SESSION_INACTIVITY_TIMEOUT_SECONDS\",\"value\":\"900\"},{\"name\":\"MYVD_CONFIG_PATH\",\"value\":\"WEB-INF/myvd.conf\"},{\"name\":\"K8S_DASHBOARD_NAMESPACE\",\"value\":\"kubernetes-dashboard\"},{\"name\":\"K8S_CLUSTER_NAME\",\"value\":\"kubernetes\"},{\"name\":\"K8S_IMPERSONATION\",\"value\":\"true\"},{\"name\":\"PROMETHEUS_SERVICE_ACCOUNT\",\"value\":\"system:serviceaccount:monitoring:prometheus-k8s\"},{\"name\":\"SHOW_PORTAL_ORGS\",\"value\":\"true\"}],\"openunison_network_configuration\":{\"activemq_dir\":\"/tmp/amq\",\"allowed_client_names\":[],\"ciphers\":[\"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\"],\"client_auth\":\"none\",\"force_to_secure\":true,\"open_external_port\":80,\"open_port\":8080,\"path_to_deployment\":\"/usr/local/openunison/work\",\"path_to_env_file\":\"/etc/openunison/ou.env\",\"quartz_dir\":\"/tmp/quartz\",\"secure_external_port\":443,\"secure_key_alias\":\"unison-tls\",\"secure_port\":8443},\"replicas\":1,\"secret_data\":[\"AD_BIND_PASSWORD\",\"K8S_DB_SECRET\",\"unisonKeystorePassword\"],\"source_secret\":\"orchestra-secrets-source\"}}";
        JSONObject obj = (JSONObject) new JSONParser().parse(json);
        assertTrue(K8sWatcher.hasObjectChanged(obj));
    }

    @Test 
    public void testObjectIgnoredFieldsChangedNotChanged() throws Exception {
        String json = "{\"apiVersion\":\"openunison.tremolo.io/v1\",\"kind\":\"OpenUnison\",\"metadata\":{\"annotations\":{\"meta.helm.sh/release-name\":\"orchestra\",\"meta.helm.sh/release-namespace\":\"openunison\"},\"creationTimestamp\":\"2020-09-13T17:24:43Z\",\"generation\":3,\"labels\":{\"app.kubernetes.io/managed-by\":\"Helm\"},\"managedFields\":[{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:meta.helm.sh/release-name\":{},\"f:meta.helm.sh/release-namespace\":{}},\"f:labels\":{\".\":{},\"f:app.kubernetes.io/managed-by\":{}}},\"f:spec\":{\".\":{},\"f:dest_secret\":{},\"f:enable_activemq\":{},\"f:hosts\":{},\"f:image\":{},\"f:key_store\":{\".\":{},\"f:key_pairs\":{\".\":{},\"f:create_keypair_template\":{},\"f:keys\":{}},\"f:static_keys\":{},\"f:trusted_certificates\":{},\"f:update_controller\":{\".\":{},\"f:days_to_expire\":{},\"f:image\":{},\"f:schedule\":{}}},\"f:openunison_network_configuration\":{\".\":{},\"f:activemq_dir\":{},\"f:allowed_client_names\":{},\"f:ciphers\":{},\"f:client_auth\":{},\"f:force_to_secure\":{},\"f:open_external_port\":{},\"f:open_port\":{},\"f:path_to_deployment\":{},\"f:path_to_env_file\":{},\"f:quartz_dir\":{},\"f:secure_external_port\":{},\"f:secure_key_alias\":{},\"f:secure_port\":{}},\"f:replicas\":{},\"f:secret_data\":{},\"f:source_secret\":{}}},\"manager\":\"Go-http-client\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:24:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:non_secret_data\":{}}},\"manager\":\"kubectl\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:43Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:status\":{\".\":{},\"f:conditions\":{\".\":{},\"f:lastTransitionTime\":{},\"f:status\":{},\"f:type\":{}},\"f:digest\":{}}},\"manager\":\"Apache-HttpClient\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:44Z\"}],\"name\":\"orchestra\",\"namespace\":\"openunison\",\"resourceVersion\":\"4593192j\",\"selfLink\":\"/apis/openunison.tremolo.io/v1/namespaces/openunison/openunisons/orchestra\",\"uid\":\"e53f443d-6e92-40d8-9358-eb7d18e53b34\"},\"spec\":{\"dest_secret\":\"orchestra\",\"enable_activemq\":false,\"hosts\":[{\"ingress_name\":\"openunison\",\"names\":[{\"env_var\":\"OU_HOST\",\"name\":\"k8sou.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_DASHBOARD_HOST\",\"name\":\"k8sdb.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_API_HOST\",\"name\":\"k8sapi.apps.192-168-2-144.nip.io\"}],\"secret_name\":\"ou-tls-certificate\"}],\"image\":\"docker.io/tremolosecurity/openunison-k8s-login-activedirectory:latest\",\"key_store\":{\"key_pairs\":{\"create_keypair_template\":[{\"name\":\"ou\",\"value\":\"Kubernetes\"},{\"name\":\"o\",\"value\":\"MyOrg\"},{\"name\":\"l\",\"value\":\"My Cluster\"},{\"name\":\"st\",\"value\":\"State of Cluster\"},{\"name\":\"c\",\"value\":\"MyCountry\"}],\"keys\":[{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"openunison.openunison.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-tls\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"k8sou.apps.192-168-2-144.nip.io\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[\"k8sdb.apps.192-168-2-144.nip.io\",\"k8sapi.apps.192-168-2-144.nip.io\"]},\"import_into_ks\":\"certificate\",\"name\":\"unison-ca\",\"tls_secret_name\":\"ou-tls-certificate\"},{\"create_data\":{\"ca_cert\":true,\"delete_pods_labels\":[\"k8s-app=kubernetes-dashboard\"],\"key_size\":2048,\"secret_info\":{\"cert_name\":\"dashboard.crt\",\"key_name\":\"dashboard.key\",\"type_of_secret\":\"Opaque\"},\"server_name\":\"kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[],\"target_namespace\":\"kubernetes-dashboard\"},\"import_into_ks\":\"certificate\",\"name\":\"kubernetes-dashboard\",\"replace_if_exists\":true,\"tls_secret_name\":\"kubernetes-dashboard-certs\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"unison-saml2-rp-sig\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-saml2-rp-sig\"}]},\"static_keys\":[{\"name\":\"session-unison\",\"version\":1},{\"name\":\"lastmile-oidc\",\"version\":1}],\"trusted_certificates\":[{\"name\":\"ldaps\",\"pem_data\":\"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURORENDQWh5Z0F3SUJBZ0lRYlJOajZSS3F0cVZQdlc2NXFaeFhYakFOQmdrcWhraUc5dzBCQVFVRkFEQWkKTVNBd0hnWURWUVFEREJkQlJFWlRMa1ZPVkRKTE1USXVSRTlOUVVsT0xrTlBUVEFlRncweE5EQXpNamd3TVRBMQpNek5hRncweU5EQXpNalV3TVRBMU16TmFNQ0l4SURBZUJnTlZCQU1NRjBGRVJsTXVSVTVVTWtzeE1pNUVUMDFCClNVNHVRMDlOTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyczlKa2VOQUhPa1EKMVFZSmdqZWZVd2Nhb2dFTWNhVy9rb0ErYnU5eGJyNHJIeS8yZ04va2M4T2tvUHV3Si9uTmxPSU8rcytNYm5YUwpMOW1VVEM0T0s3dHJrRWppS1hCK0QrVlNZeTZpbVhoNnpwQnROYmVaeXgrcmRCbmFPdjNCeVpSbm5FQjhMbWhNCnZIQSs0Zi90OWZ4LzJ2dDZ3UHgvL1ZnSXE5eXVZWVVRUkxtMVdqeVVCRnJaZUdvU3BQbTBLZXdtK0IwYmhtTWIKZHlDKzNmaGFLQytVazFOUG9kRTI5NzNqTEJaSmVsWnhzWlk0MFd3OHpZUXdkR1lJYlhxb1RjKzFhL3g0ZjFFbgptNEFOcWdnSHR3K05xOHpoc3MzeVR0WStVWUtEUkJJTGRMVlpRaEhKRXhlMGtBZWlzZ014SS9iQndPMUhickZWCit6U25rK252Z1FJREFRQUJvMll3WkRBekJnTlZIU1VFTERBcUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SUcKQ2lzR0FRUUJnamNVQWdJR0NDc0dBUVVGQndNRE1CMEdBMVVkRGdRV0JCVHlKVWZZNjZ6WWJtOWkweGVZSHVGSQo0TU43dURBT0JnTlZIUThCQWY4RUJBTUNCU0F3RFFZSktvWklodmNOQVFFRkJRQURnZ0VCQU01a3o5T0tOU3VYCjh3NE5PZ25mSUZkYXpkMG5QbElVYnZEVmZRb055OVEwUzFTRlVWTWVrSVBOaVZoZkd6eWE5SXdSdEdiMVZhQlEKQVEyT1JJekhyOEEycjVVTkx4M21GanBKbWVPeFF3bFYwWCtnOHMrMjUzS1ZGeE9wUkU2eXlhZ24vQnh4cHRUTAphMVo0cWVRSkxENDJsZDFxR2xSd0Z0VlJtVkZaelZYVnJwdTdOdUZkM3Zsbm5PL3FLV1hVK3VNc2ZYdHNsMTNuCmVjMWt3MUV3cTJqbks4V0ltS1RRNy85V2JhSVkwZ3g4bW93Q0pTT3NScTBURTd6Sy9ONTVkck4xd1hKVnhXZTUKNE4zMmVDcW90WHk5ajlsemRrTmE3YXdiOXEzOG5XVnhQK3ZhNWpxTklEbGxqQjZ0RXh5NW4zczd0NktLNmc1agpUWmdWcXJaMyttcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQoK\"}],\"update_controller\":{\"days_to_expire\":10,\"image\":\"docker.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0\",\"schedule\":\"0 2 * * *\"}},\"non_secret_data\":[{\"name\":\"K8S_URL\",\"value\":\"https://k8sapi.apps.192-168-2-144.nip.io\"},{\"name\":\"AD_BASE_DN\",\"value\":\"cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_HOST\",\"value\":\"192.168.2.75\"},{\"name\":\"AD_PORT\",\"value\":\"636\"},{\"name\":\"AD_BIND_DN\",\"value\":\"cn=Administrator,cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_CON_TYPE\",\"value\":\"ldaps\"},{\"name\":\"SRV_DNS\",\"value\":\"false\"},{\"name\":\"SESSION_INACTIVITY_TIMEOUT_SECONDS\",\"value\":\"900\"},{\"name\":\"MYVD_CONFIG_PATH\",\"value\":\"WEB-INF/myvd.conf\"},{\"name\":\"K8S_DASHBOARD_NAMESPACE\",\"value\":\"kubernetes-dashboard\"},{\"name\":\"K8S_CLUSTER_NAME\",\"value\":\"kubernetes\"},{\"name\":\"K8S_IMPERSONATION\",\"value\":\"true\"},{\"name\":\"PROMETHEUS_SERVICE_ACCOUNT\",\"value\":\"system:serviceaccount:monitoring:prometheus-k8s\"},{\"name\":\"SHOW_PORTAL_ORGS\",\"value\":\"true\"}],\"openunison_network_configuration\":{\"activemq_dir\":\"/tmp/amq\",\"allowed_client_names\":[],\"ciphers\":[\"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\"],\"client_auth\":\"none\",\"force_to_secure\":true,\"open_external_port\":80,\"open_port\":8080,\"path_to_deployment\":\"/usr/local/openunison/work\",\"path_to_env_file\":\"/etc/openunison/ou.env\",\"quartz_dir\":\"/tmp/quartz\",\"secure_external_port\":443,\"secure_key_alias\":\"unison-tls\",\"secure_port\":8443},\"replicas\":1,\"secret_data\":[\"AD_BIND_PASSWORD\",\"K8S_DB_SECRET\",\"unisonKeystorePassword\"],\"source_secret\":\"orchestra-secrets-source\"},\"status\":{\"conditions\":{\"lastTransitionTime\":\"2020-09-13 05:50:44GMT\",\"status\":\"True\",\"type\":\"Completed\"},\"digest\":\"+pXYDf/HO3q05phi6btzAKmFO1hun06uNtBx7OHJ6i8=\"}}";
        JSONObject obj = (JSONObject) new JSONParser().parse(json);
        assertFalse(K8sWatcher.hasObjectChanged(obj));
    }

    @Test
    public void testObjectTrackedFieldsChangedHasChanged() throws Exception {
        String json = "{\"apiVersion\":\"openunison.tremolo.io/v1\",\"kind\":\"OpenUnison\",\"metadata\":{\"annotations\":{\"meta.helm.sh/release-name\":\"orchestra\",\"meta.helm.sh/release-namespace\":\"openunison\"},\"creationTimestamp\":\"2020-09-13T17:24:42Z\",\"generation\":2,\"labels\":{\"app.kubernetes.io/managed-by\":\"Helm\"},\"managedFields\":[{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:meta.helm.sh/release-name\":{},\"f:meta.helm.sh/release-namespace\":{}},\"f:labels\":{\".\":{},\"f:app.kubernetes.io/managed-by\":{}}},\"f:spec\":{\".\":{},\"f:dest_secret\":{},\"f:enable_activemq\":{},\"f:hosts\":{},\"f:image\":{},\"f:key_store\":{\".\":{},\"f:key_pairs\":{\".\":{},\"f:create_keypair_template\":{},\"f:keys\":{}},\"f:static_keys\":{},\"f:trusted_certificates\":{},\"f:update_controller\":{\".\":{},\"f:days_to_expire\":{},\"f:image\":{},\"f:schedule\":{}}},\"f:openunison_network_configuration\":{\".\":{},\"f:activemq_dir\":{},\"f:allowed_client_names\":{},\"f:ciphers\":{},\"f:client_auth\":{},\"f:force_to_secure\":{},\"f:open_external_port\":{},\"f:open_port\":{},\"f:path_to_deployment\":{},\"f:path_to_env_file\":{},\"f:quartz_dir\":{},\"f:secure_external_port\":{},\"f:secure_key_alias\":{},\"f:secure_port\":{}},\"f:replicas\":{},\"f:secret_data\":{},\"f:source_secret\":{}}},\"manager\":\"Go-http-client\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:24:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:non_secret_data\":{}}},\"manager\":\"kubectl\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:status\":{\".\":{},\"f:conditions\":{\".\":{},\"f:lastTransitionTime\":{},\"f:status\":{},\"f:type\":{}},\"f:digest\":{}}},\"manager\":\"Apache-HttpClient\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:44Z\"}],\"name\":\"orchestra\",\"namespace\":\"openunison\",\"resourceVersion\":\"4593192\",\"selfLink\":\"/apis/openunison.tremolo.io/v1/namespaces/openunison/openunisons/orchestra\",\"uid\":\"e53f443d-6e92-40d8-9358-eb7d18e53b34\"},\"spec\":{\"dest_secret\":\"orchestra\",\"enable_activemq\":false,\"hosts\":[{\"ingress_name\":\"openunison\",\"names\":[{\"env_var\":\"OU_HOST\",\"name\":\"k8sou.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_DASHBOARD_HOST\",\"name\":\"k8sdb.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_API_HOST\",\"name\":\"k8sapi.apps.192-168-2-144.nip.io\"}],\"secret_name\":\"ou-tls-certificate\"}],\"image\":\"docker.io/tremolosecurity/openunison-k8s-login-activedirectory:latest\",\"key_store\":{\"key_pairs\":{\"create_keypair_template\":[{\"name\":\"ou\",\"value\":\"Kubernetes\"},{\"name\":\"o\",\"value\":\"MyOrg\"},{\"name\":\"l\",\"value\":\"My Cluster\"},{\"name\":\"st\",\"value\":\"State of Cluster\"},{\"name\":\"c\",\"value\":\"MyCountry\"}],\"keys\":[{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"openunison.openunison.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-tls\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"k8sou.apps.192-168-2-144.nip.io\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[\"k8sdb.apps.192-168-2-144.nip.io\",\"k8sapi.apps.192-168-2-144.nip.io\"]},\"import_into_ks\":\"certificate\",\"name\":\"unison-ca\",\"tls_secret_name\":\"ou-tls-certificate\"},{\"create_data\":{\"ca_cert\":true,\"delete_pods_labels\":[\"k8s-app=kubernetes-dashboard\"],\"key_size\":2048,\"secret_info\":{\"cert_name\":\"dashboard.crt\",\"key_name\":\"dashboard.key\",\"type_of_secret\":\"Opaque\"},\"server_name\":\"kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[],\"target_namespace\":\"kubernetes-dashboard\"},\"import_into_ks\":\"certificate\",\"name\":\"kubernetes-dashboard\",\"replace_if_exists\":true,\"tls_secret_name\":\"kubernetes-dashboard-certs\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"unison-saml2-rp-sig\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-saml2-rp-sig\"}]},\"static_keys\":[{\"name\":\"session-unison\",\"version\":1},{\"name\":\"lastmile-oidc\",\"version\":1}],\"trusted_certificates\":[{\"name\":\"ldaps\",\"pem_data\":\"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURORENDQWh5Z0F3SUJBZ0lRYlJOajZSS3F0cVZQdlc2NXFaeFhYakFOQmdrcWhraUc5dzBCQVFVRkFEQWkKTVNBd0hnWURWUVFEREJkQlJFWlRMa1ZPVkRKTE1USXVSRTlOUVVsT0xrTlBUVEFlRncweE5EQXpNamd3TVRBMQpNek5hRncweU5EQXpNalV3TVRBMU16TmFNQ0l4SURBZUJnTlZCQU1NRjBGRVJsTXVSVTVVTWtzeE1pNUVUMDFCClNVNHVRMDlOTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyczlKa2VOQUhPa1EKMVFZSmdqZWZVd2Nhb2dFTWNhVy9rb0ErYnU5eGJyNHJIeS8yZ04va2M4T2tvUHV3Si9uTmxPSU8rcytNYm5YUwpMOW1VVEM0T0s3dHJrRWppS1hCK0QrVlNZeTZpbVhoNnpwQnROYmVaeXgrcmRCbmFPdjNCeVpSbm5FQjhMbWhNCnZIQSs0Zi90OWZ4LzJ2dDZ3UHgvL1ZnSXE5eXVZWVVRUkxtMVdqeVVCRnJaZUdvU3BQbTBLZXdtK0IwYmhtTWIKZHlDKzNmaGFLQytVazFOUG9kRTI5NzNqTEJaSmVsWnhzWlk0MFd3OHpZUXdkR1lJYlhxb1RjKzFhL3g0ZjFFbgptNEFOcWdnSHR3K05xOHpoc3MzeVR0WStVWUtEUkJJTGRMVlpRaEhKRXhlMGtBZWlzZ014SS9iQndPMUhickZWCit6U25rK252Z1FJREFRQUJvMll3WkRBekJnTlZIU1VFTERBcUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SUcKQ2lzR0FRUUJnamNVQWdJR0NDc0dBUVVGQndNRE1CMEdBMVVkRGdRV0JCVHlKVWZZNjZ6WWJtOWkweGVZSHVGSQo0TU43dURBT0JnTlZIUThCQWY4RUJBTUNCU0F3RFFZSktvWklodmNOQVFFRkJRQURnZ0VCQU01a3o5T0tOU3VYCjh3NE5PZ25mSUZkYXpkMG5QbElVYnZEVmZRb055OVEwUzFTRlVWTWVrSVBOaVZoZkd6eWE5SXdSdEdiMVZhQlEKQVEyT1JJekhyOEEycjVVTkx4M21GanBKbWVPeFF3bFYwWCtnOHMrMjUzS1ZGeE9wUkU2eXlhZ24vQnh4cHRUTAphMVo0cWVRSkxENDJsZDFxR2xSd0Z0VlJtVkZaelZYVnJwdTdOdUZkM3Zsbm5PL3FLV1hVK3VNc2ZYdHNsMTNuCmVjMWt3MUV3cTJqbks4V0ltS1RRNy85V2JhSVkwZ3g4bW93Q0pTT3NScTBURTd6Sy9ONTVkck4xd1hKVnhXZTUKNE4zMmVDcW90WHk5ajlsemRrTmE3YXdiOXEzOG5XVnhQK3ZhNWpxTklEbGxqQjZ0RXh5NW4zczd0NktLNmc1agpUWmdWcXJaMyttcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQoK\"}],\"update_controller\":{\"days_to_expire\":10,\"image\":\"docker.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0\",\"schedule\":\"0 2 * * *\"}},\"non_secret_data\":[{\"name\":\"K8S_URL\",\"value\":\"https://k8sapi.apps.192-168-2-144.nip.io\"},{\"name\":\"AD_BASE_DN\",\"value\":\"cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_HOST\",\"value\":\"192.168.2.75\"},{\"name\":\"AD_PORT\",\"value\":\"636\"},{\"name\":\"AD_BIND_DN\",\"value\":\"cn=Administrator,cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_CON_TYPE\",\"value\":\"ldaps\"},{\"name\":\"SRV_DNS\",\"value\":\"false\"},{\"name\":\"SESSION_INACTIVITY_TIMEOUT_SECONDS\",\"value\":\"900\"},{\"name\":\"MYVD_CONFIG_PATH\",\"value\":\"WEB-INF/myvd.conf\"},{\"name\":\"K8S_DASHBOARD_NAMESPACE\",\"value\":\"kubernetes-dashboard\"},{\"name\":\"K8S_CLUSTER_NAME\",\"value\":\"kubernetes\"},{\"name\":\"K8S_IMPERSONATION\",\"value\":\"true\"},{\"name\":\"PROMETHEUS_SERVICE_ACCOUNT\",\"value\":\"system:serviceaccount:monitoring:prometheus-k8s\"},{\"name\":\"SHOW_PORTAL_ORGS\",\"value\":\"false\"}],\"openunison_network_configuration\":{\"activemq_dir\":\"/tmp/amq\",\"allowed_client_names\":[],\"ciphers\":[\"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\"],\"client_auth\":\"none\",\"force_to_secure\":true,\"open_external_port\":80,\"open_port\":8080,\"path_to_deployment\":\"/usr/local/openunison/work\",\"path_to_env_file\":\"/etc/openunison/ou.env\",\"quartz_dir\":\"/tmp/quartz\",\"secure_external_port\":443,\"secure_key_alias\":\"unison-tls\",\"secure_port\":8443},\"replicas\":1,\"secret_data\":[\"AD_BIND_PASSWORD\",\"K8S_DB_SECRET\",\"unisonKeystorePassword\"],\"source_secret\":\"orchestra-secrets-source\"},\"status\":{\"conditions\":{\"lastTransitionTime\":\"2020-09-13 05:50:44GMT\",\"status\":\"True\",\"type\":\"Completed\"},\"digest\":\"+pXYDf/HO3q05phi6btzAKmFO1hun06uNtBx7OHJ6i8=\"}}";
        JSONObject obj = (JSONObject) new JSONParser().parse(json);
        assertTrue(K8sWatcher.hasObjectChanged(obj));
    }

    @Test
    public void testObjectLabelsChangedHasChanged() throws Exception {
        String json = "{\"apiVersion\":\"openunison.tremolo.io/v1\",\"kind\":\"OpenUnison\",\"metadata\":{\"annotations\":{\"meta.helm.sh/release-name\":\"orchestra\",\"meta.helm.sh/release-namespace\":\"openunison\"},\"creationTimestamp\":\"2020-09-13T17:24:42Z\",\"generation\":2,\"labels\":{\"app.kubernetes.io/managed-by\":\"Helm\",\"this\":\"isnew\"},\"managedFields\":[{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:meta.helm.sh/release-name\":{},\"f:meta.helm.sh/release-namespace\":{}},\"f:labels\":{\".\":{},\"f:app.kubernetes.io/managed-by\":{}}},\"f:spec\":{\".\":{},\"f:dest_secret\":{},\"f:enable_activemq\":{},\"f:hosts\":{},\"f:image\":{},\"f:key_store\":{\".\":{},\"f:key_pairs\":{\".\":{},\"f:create_keypair_template\":{},\"f:keys\":{}},\"f:static_keys\":{},\"f:trusted_certificates\":{},\"f:update_controller\":{\".\":{},\"f:days_to_expire\":{},\"f:image\":{},\"f:schedule\":{}}},\"f:openunison_network_configuration\":{\".\":{},\"f:activemq_dir\":{},\"f:allowed_client_names\":{},\"f:ciphers\":{},\"f:client_auth\":{},\"f:force_to_secure\":{},\"f:open_external_port\":{},\"f:open_port\":{},\"f:path_to_deployment\":{},\"f:path_to_env_file\":{},\"f:quartz_dir\":{},\"f:secure_external_port\":{},\"f:secure_key_alias\":{},\"f:secure_port\":{}},\"f:replicas\":{},\"f:secret_data\":{},\"f:source_secret\":{}}},\"manager\":\"Go-http-client\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:24:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:non_secret_data\":{}}},\"manager\":\"kubectl\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:status\":{\".\":{},\"f:conditions\":{\".\":{},\"f:lastTransitionTime\":{},\"f:status\":{},\"f:type\":{}},\"f:digest\":{}}},\"manager\":\"Apache-HttpClient\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:44Z\"}],\"name\":\"orchestra\",\"namespace\":\"openunison\",\"resourceVersion\":\"4593192\",\"selfLink\":\"/apis/openunison.tremolo.io/v1/namespaces/openunison/openunisons/orchestra\",\"uid\":\"e53f443d-6e92-40d8-9358-eb7d18e53b34\"},\"spec\":{\"dest_secret\":\"orchestra\",\"enable_activemq\":false,\"hosts\":[{\"ingress_name\":\"openunison\",\"names\":[{\"env_var\":\"OU_HOST\",\"name\":\"k8sou.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_DASHBOARD_HOST\",\"name\":\"k8sdb.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_API_HOST\",\"name\":\"k8sapi.apps.192-168-2-144.nip.io\"}],\"secret_name\":\"ou-tls-certificate\"}],\"image\":\"docker.io/tremolosecurity/openunison-k8s-login-activedirectory:latest\",\"key_store\":{\"key_pairs\":{\"create_keypair_template\":[{\"name\":\"ou\",\"value\":\"Kubernetes\"},{\"name\":\"o\",\"value\":\"MyOrg\"},{\"name\":\"l\",\"value\":\"My Cluster\"},{\"name\":\"st\",\"value\":\"State of Cluster\"},{\"name\":\"c\",\"value\":\"MyCountry\"}],\"keys\":[{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"openunison.openunison.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-tls\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"k8sou.apps.192-168-2-144.nip.io\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[\"k8sdb.apps.192-168-2-144.nip.io\",\"k8sapi.apps.192-168-2-144.nip.io\"]},\"import_into_ks\":\"certificate\",\"name\":\"unison-ca\",\"tls_secret_name\":\"ou-tls-certificate\"},{\"create_data\":{\"ca_cert\":true,\"delete_pods_labels\":[\"k8s-app=kubernetes-dashboard\"],\"key_size\":2048,\"secret_info\":{\"cert_name\":\"dashboard.crt\",\"key_name\":\"dashboard.key\",\"type_of_secret\":\"Opaque\"},\"server_name\":\"kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[],\"target_namespace\":\"kubernetes-dashboard\"},\"import_into_ks\":\"certificate\",\"name\":\"kubernetes-dashboard\",\"replace_if_exists\":true,\"tls_secret_name\":\"kubernetes-dashboard-certs\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"unison-saml2-rp-sig\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-saml2-rp-sig\"}]},\"static_keys\":[{\"name\":\"session-unison\",\"version\":1},{\"name\":\"lastmile-oidc\",\"version\":1}],\"trusted_certificates\":[{\"name\":\"ldaps\",\"pem_data\":\"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURORENDQWh5Z0F3SUJBZ0lRYlJOajZSS3F0cVZQdlc2NXFaeFhYakFOQmdrcWhraUc5dzBCQVFVRkFEQWkKTVNBd0hnWURWUVFEREJkQlJFWlRMa1ZPVkRKTE1USXVSRTlOUVVsT0xrTlBUVEFlRncweE5EQXpNamd3TVRBMQpNek5hRncweU5EQXpNalV3TVRBMU16TmFNQ0l4SURBZUJnTlZCQU1NRjBGRVJsTXVSVTVVTWtzeE1pNUVUMDFCClNVNHVRMDlOTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyczlKa2VOQUhPa1EKMVFZSmdqZWZVd2Nhb2dFTWNhVy9rb0ErYnU5eGJyNHJIeS8yZ04va2M4T2tvUHV3Si9uTmxPSU8rcytNYm5YUwpMOW1VVEM0T0s3dHJrRWppS1hCK0QrVlNZeTZpbVhoNnpwQnROYmVaeXgrcmRCbmFPdjNCeVpSbm5FQjhMbWhNCnZIQSs0Zi90OWZ4LzJ2dDZ3UHgvL1ZnSXE5eXVZWVVRUkxtMVdqeVVCRnJaZUdvU3BQbTBLZXdtK0IwYmhtTWIKZHlDKzNmaGFLQytVazFOUG9kRTI5NzNqTEJaSmVsWnhzWlk0MFd3OHpZUXdkR1lJYlhxb1RjKzFhL3g0ZjFFbgptNEFOcWdnSHR3K05xOHpoc3MzeVR0WStVWUtEUkJJTGRMVlpRaEhKRXhlMGtBZWlzZ014SS9iQndPMUhickZWCit6U25rK252Z1FJREFRQUJvMll3WkRBekJnTlZIU1VFTERBcUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SUcKQ2lzR0FRUUJnamNVQWdJR0NDc0dBUVVGQndNRE1CMEdBMVVkRGdRV0JCVHlKVWZZNjZ6WWJtOWkweGVZSHVGSQo0TU43dURBT0JnTlZIUThCQWY4RUJBTUNCU0F3RFFZSktvWklodmNOQVFFRkJRQURnZ0VCQU01a3o5T0tOU3VYCjh3NE5PZ25mSUZkYXpkMG5QbElVYnZEVmZRb055OVEwUzFTRlVWTWVrSVBOaVZoZkd6eWE5SXdSdEdiMVZhQlEKQVEyT1JJekhyOEEycjVVTkx4M21GanBKbWVPeFF3bFYwWCtnOHMrMjUzS1ZGeE9wUkU2eXlhZ24vQnh4cHRUTAphMVo0cWVRSkxENDJsZDFxR2xSd0Z0VlJtVkZaelZYVnJwdTdOdUZkM3Zsbm5PL3FLV1hVK3VNc2ZYdHNsMTNuCmVjMWt3MUV3cTJqbks4V0ltS1RRNy85V2JhSVkwZ3g4bW93Q0pTT3NScTBURTd6Sy9ONTVkck4xd1hKVnhXZTUKNE4zMmVDcW90WHk5ajlsemRrTmE3YXdiOXEzOG5XVnhQK3ZhNWpxTklEbGxqQjZ0RXh5NW4zczd0NktLNmc1agpUWmdWcXJaMyttcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQoK\"}],\"update_controller\":{\"days_to_expire\":10,\"image\":\"docker.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0\",\"schedule\":\"0 2 * * *\"}},\"non_secret_data\":[{\"name\":\"K8S_URL\",\"value\":\"https://k8sapi.apps.192-168-2-144.nip.io\"},{\"name\":\"AD_BASE_DN\",\"value\":\"cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_HOST\",\"value\":\"192.168.2.75\"},{\"name\":\"AD_PORT\",\"value\":\"636\"},{\"name\":\"AD_BIND_DN\",\"value\":\"cn=Administrator,cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_CON_TYPE\",\"value\":\"ldaps\"},{\"name\":\"SRV_DNS\",\"value\":\"false\"},{\"name\":\"SESSION_INACTIVITY_TIMEOUT_SECONDS\",\"value\":\"900\"},{\"name\":\"MYVD_CONFIG_PATH\",\"value\":\"WEB-INF/myvd.conf\"},{\"name\":\"K8S_DASHBOARD_NAMESPACE\",\"value\":\"kubernetes-dashboard\"},{\"name\":\"K8S_CLUSTER_NAME\",\"value\":\"kubernetes\"},{\"name\":\"K8S_IMPERSONATION\",\"value\":\"true\"},{\"name\":\"PROMETHEUS_SERVICE_ACCOUNT\",\"value\":\"system:serviceaccount:monitoring:prometheus-k8s\"},{\"name\":\"SHOW_PORTAL_ORGS\",\"value\":\"true\"}],\"openunison_network_configuration\":{\"activemq_dir\":\"/tmp/amq\",\"allowed_client_names\":[],\"ciphers\":[\"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\"],\"client_auth\":\"none\",\"force_to_secure\":true,\"open_external_port\":80,\"open_port\":8080,\"path_to_deployment\":\"/usr/local/openunison/work\",\"path_to_env_file\":\"/etc/openunison/ou.env\",\"quartz_dir\":\"/tmp/quartz\",\"secure_external_port\":443,\"secure_key_alias\":\"unison-tls\",\"secure_port\":8443},\"replicas\":1,\"secret_data\":[\"AD_BIND_PASSWORD\",\"K8S_DB_SECRET\",\"unisonKeystorePassword\"],\"source_secret\":\"orchestra-secrets-source\"},\"status\":{\"conditions\":{\"lastTransitionTime\":\"2020-09-13 05:50:44GMT\",\"status\":\"True\",\"type\":\"Completed\"},\"digest\":\"+pXYDf/HO3q05phi6btzAKmFO1hun06uNtBx7OHJ6i8=\"}}";
        JSONObject obj = (JSONObject) new JSONParser().parse(json);
        assertTrue(K8sWatcher.hasObjectChanged(obj));
    }

    @Test
    public void testObjectAnnotationsFieldsChangedHasChanged() throws Exception {
        String json = "{\"apiVersion\":\"openunison.tremolo.io/v1\",\"kind\":\"OpenUnison\",\"metadata\":{\"annotations\":{\"meta.helm.sh/release-name\":\"orchestra\",\"meta.helm.sh/release-namespace\":\"openunison\",\"myannotation\":\"myvalue\"},\"creationTimestamp\":\"2020-09-13T17:24:42Z\",\"generation\":2,\"labels\":{\"app.kubernetes.io/managed-by\":\"Helm\"},\"managedFields\":[{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:metadata\":{\"f:annotations\":{\".\":{},\"f:meta.helm.sh/release-name\":{},\"f:meta.helm.sh/release-namespace\":{}},\"f:labels\":{\".\":{},\"f:app.kubernetes.io/managed-by\":{}}},\"f:spec\":{\".\":{},\"f:dest_secret\":{},\"f:enable_activemq\":{},\"f:hosts\":{},\"f:image\":{},\"f:key_store\":{\".\":{},\"f:key_pairs\":{\".\":{},\"f:create_keypair_template\":{},\"f:keys\":{}},\"f:static_keys\":{},\"f:trusted_certificates\":{},\"f:update_controller\":{\".\":{},\"f:days_to_expire\":{},\"f:image\":{},\"f:schedule\":{}}},\"f:openunison_network_configuration\":{\".\":{},\"f:activemq_dir\":{},\"f:allowed_client_names\":{},\"f:ciphers\":{},\"f:client_auth\":{},\"f:force_to_secure\":{},\"f:open_external_port\":{},\"f:open_port\":{},\"f:path_to_deployment\":{},\"f:path_to_env_file\":{},\"f:quartz_dir\":{},\"f:secure_external_port\":{},\"f:secure_key_alias\":{},\"f:secure_port\":{}},\"f:replicas\":{},\"f:secret_data\":{},\"f:source_secret\":{}}},\"manager\":\"Go-http-client\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:24:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:spec\":{\"f:non_secret_data\":{}}},\"manager\":\"kubectl\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:42Z\"},{\"apiVersion\":\"openunison.tremolo.io/v1\",\"fieldsType\":\"FieldsV1\",\"fieldsV1\":{\"f:status\":{\".\":{},\"f:conditions\":{\".\":{},\"f:lastTransitionTime\":{},\"f:status\":{},\"f:type\":{}},\"f:digest\":{}}},\"manager\":\"Apache-HttpClient\",\"operation\":\"Update\",\"time\":\"2020-09-13T17:50:44Z\"}],\"name\":\"orchestra\",\"namespace\":\"openunison\",\"resourceVersion\":\"4593192\",\"selfLink\":\"/apis/openunison.tremolo.io/v1/namespaces/openunison/openunisons/orchestra\",\"uid\":\"e53f443d-6e92-40d8-9358-eb7d18e53b34\"},\"spec\":{\"dest_secret\":\"orchestra\",\"enable_activemq\":false,\"hosts\":[{\"ingress_name\":\"openunison\",\"names\":[{\"env_var\":\"OU_HOST\",\"name\":\"k8sou.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_DASHBOARD_HOST\",\"name\":\"k8sdb.apps.192-168-2-144.nip.io\"},{\"env_var\":\"K8S_API_HOST\",\"name\":\"k8sapi.apps.192-168-2-144.nip.io\"}],\"secret_name\":\"ou-tls-certificate\"}],\"image\":\"docker.io/tremolosecurity/openunison-k8s-login-activedirectory:latest\",\"key_store\":{\"key_pairs\":{\"create_keypair_template\":[{\"name\":\"ou\",\"value\":\"Kubernetes\"},{\"name\":\"o\",\"value\":\"MyOrg\"},{\"name\":\"l\",\"value\":\"My Cluster\"},{\"name\":\"st\",\"value\":\"State of Cluster\"},{\"name\":\"c\",\"value\":\"MyCountry\"}],\"keys\":[{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"openunison.openunison.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-tls\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"k8sou.apps.192-168-2-144.nip.io\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[\"k8sdb.apps.192-168-2-144.nip.io\",\"k8sapi.apps.192-168-2-144.nip.io\"]},\"import_into_ks\":\"certificate\",\"name\":\"unison-ca\",\"tls_secret_name\":\"ou-tls-certificate\"},{\"create_data\":{\"ca_cert\":true,\"delete_pods_labels\":[\"k8s-app=kubernetes-dashboard\"],\"key_size\":2048,\"secret_info\":{\"cert_name\":\"dashboard.crt\",\"key_name\":\"dashboard.key\",\"type_of_secret\":\"Opaque\"},\"server_name\":\"kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[],\"target_namespace\":\"kubernetes-dashboard\"},\"import_into_ks\":\"certificate\",\"name\":\"kubernetes-dashboard\",\"replace_if_exists\":true,\"tls_secret_name\":\"kubernetes-dashboard-certs\"},{\"create_data\":{\"ca_cert\":true,\"key_size\":2048,\"server_name\":\"unison-saml2-rp-sig\",\"sign_by_k8s_ca\":false,\"subject_alternative_names\":[]},\"import_into_ks\":\"keypair\",\"name\":\"unison-saml2-rp-sig\"}]},\"static_keys\":[{\"name\":\"session-unison\",\"version\":1},{\"name\":\"lastmile-oidc\",\"version\":1}],\"trusted_certificates\":[{\"name\":\"ldaps\",\"pem_data\":\"LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURORENDQWh5Z0F3SUJBZ0lRYlJOajZSS3F0cVZQdlc2NXFaeFhYakFOQmdrcWhraUc5dzBCQVFVRkFEQWkKTVNBd0hnWURWUVFEREJkQlJFWlRMa1ZPVkRKTE1USXVSRTlOUVVsT0xrTlBUVEFlRncweE5EQXpNamd3TVRBMQpNek5hRncweU5EQXpNalV3TVRBMU16TmFNQ0l4SURBZUJnTlZCQU1NRjBGRVJsTXVSVTVVTWtzeE1pNUVUMDFCClNVNHVRMDlOTUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUEyczlKa2VOQUhPa1EKMVFZSmdqZWZVd2Nhb2dFTWNhVy9rb0ErYnU5eGJyNHJIeS8yZ04va2M4T2tvUHV3Si9uTmxPSU8rcytNYm5YUwpMOW1VVEM0T0s3dHJrRWppS1hCK0QrVlNZeTZpbVhoNnpwQnROYmVaeXgrcmRCbmFPdjNCeVpSbm5FQjhMbWhNCnZIQSs0Zi90OWZ4LzJ2dDZ3UHgvL1ZnSXE5eXVZWVVRUkxtMVdqeVVCRnJaZUdvU3BQbTBLZXdtK0IwYmhtTWIKZHlDKzNmaGFLQytVazFOUG9kRTI5NzNqTEJaSmVsWnhzWlk0MFd3OHpZUXdkR1lJYlhxb1RjKzFhL3g0ZjFFbgptNEFOcWdnSHR3K05xOHpoc3MzeVR0WStVWUtEUkJJTGRMVlpRaEhKRXhlMGtBZWlzZ014SS9iQndPMUhickZWCit6U25rK252Z1FJREFRQUJvMll3WkRBekJnTlZIU1VFTERBcUJnZ3JCZ0VGQlFjREFRWUlLd1lCQlFVSEF3SUcKQ2lzR0FRUUJnamNVQWdJR0NDc0dBUVVGQndNRE1CMEdBMVVkRGdRV0JCVHlKVWZZNjZ6WWJtOWkweGVZSHVGSQo0TU43dURBT0JnTlZIUThCQWY4RUJBTUNCU0F3RFFZSktvWklodmNOQVFFRkJRQURnZ0VCQU01a3o5T0tOU3VYCjh3NE5PZ25mSUZkYXpkMG5QbElVYnZEVmZRb055OVEwUzFTRlVWTWVrSVBOaVZoZkd6eWE5SXdSdEdiMVZhQlEKQVEyT1JJekhyOEEycjVVTkx4M21GanBKbWVPeFF3bFYwWCtnOHMrMjUzS1ZGeE9wUkU2eXlhZ24vQnh4cHRUTAphMVo0cWVRSkxENDJsZDFxR2xSd0Z0VlJtVkZaelZYVnJwdTdOdUZkM3Zsbm5PL3FLV1hVK3VNc2ZYdHNsMTNuCmVjMWt3MUV3cTJqbks4V0ltS1RRNy85V2JhSVkwZ3g4bW93Q0pTT3NScTBURTd6Sy9ONTVkck4xd1hKVnhXZTUKNE4zMmVDcW90WHk5ajlsemRrTmE3YXdiOXEzOG5XVnhQK3ZhNWpxTklEbGxqQjZ0RXh5NW4zczd0NktLNmc1agpUWmdWcXJaMyttcz0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQoK\"}],\"update_controller\":{\"days_to_expire\":10,\"image\":\"docker.io/tremolosecurity/kubernetes-artifact-deployment:1.1.0\",\"schedule\":\"0 2 * * *\"}},\"non_secret_data\":[{\"name\":\"K8S_URL\",\"value\":\"https://k8sapi.apps.192-168-2-144.nip.io\"},{\"name\":\"AD_BASE_DN\",\"value\":\"cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_HOST\",\"value\":\"192.168.2.75\"},{\"name\":\"AD_PORT\",\"value\":\"636\"},{\"name\":\"AD_BIND_DN\",\"value\":\"cn=Administrator,cn=users,dc=ent2k12,dc=domain,dc=com\"},{\"name\":\"AD_CON_TYPE\",\"value\":\"ldaps\"},{\"name\":\"SRV_DNS\",\"value\":\"false\"},{\"name\":\"SESSION_INACTIVITY_TIMEOUT_SECONDS\",\"value\":\"900\"},{\"name\":\"MYVD_CONFIG_PATH\",\"value\":\"WEB-INF/myvd.conf\"},{\"name\":\"K8S_DASHBOARD_NAMESPACE\",\"value\":\"kubernetes-dashboard\"},{\"name\":\"K8S_CLUSTER_NAME\",\"value\":\"kubernetes\"},{\"name\":\"K8S_IMPERSONATION\",\"value\":\"true\"},{\"name\":\"PROMETHEUS_SERVICE_ACCOUNT\",\"value\":\"system:serviceaccount:monitoring:prometheus-k8s\"},{\"name\":\"SHOW_PORTAL_ORGS\",\"value\":\"true\"}],\"openunison_network_configuration\":{\"activemq_dir\":\"/tmp/amq\",\"allowed_client_names\":[],\"ciphers\":[\"TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_ECDSA_WITH_AES_256_GCM_SHA384\",\"TLS_ECDH_RSA_WITH_AES_256_GCM_SHA384\",\"TLS_DHE_RSA_WITH_AES_256_GCM_SHA384\"],\"client_auth\":\"none\",\"force_to_secure\":true,\"open_external_port\":80,\"open_port\":8080,\"path_to_deployment\":\"/usr/local/openunison/work\",\"path_to_env_file\":\"/etc/openunison/ou.env\",\"quartz_dir\":\"/tmp/quartz\",\"secure_external_port\":443,\"secure_key_alias\":\"unison-tls\",\"secure_port\":8443},\"replicas\":1,\"secret_data\":[\"AD_BIND_PASSWORD\",\"K8S_DB_SECRET\",\"unisonKeystorePassword\"],\"source_secret\":\"orchestra-secrets-source\"},\"status\":{\"conditions\":{\"lastTransitionTime\":\"2020-09-13 05:50:44GMT\",\"status\":\"True\",\"type\":\"Completed\"},\"digest\":\"+pXYDf/HO3q05phi6btzAKmFO1hun06uNtBx7OHJ6i8=\"}}";
        JSONObject obj = (JSONObject) new JSONParser().parse(json);
        assertTrue(K8sWatcher.hasObjectChanged(obj));
    }
}
